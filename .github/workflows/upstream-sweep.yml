name: Upstream sweep
on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set git identity
        run: |
          git config user.name  "gexu-bot"
          git config user.email "gexu-bot@users.noreply.github.com"
      - name: Mirror forks into vendor/*
        run: bash scripts/bootstrap-vendors.sh
      - name: Open/Update PRs vendor/* -> main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          for br in vendor/upstream vendor/j2k vendor/sy vendor/yokai vendor/neko vendor/komikku; do
            number=$(gh pr list --base main --head "$br" --state open --json number --jq '.[0].number' || true)
            title="Upstream sweep: ${br#vendor/}"
            body="PR automÃ¡tico para revisar cambios de \`${br#vendor/}\` contra \`main\`.\n\n**No hacer merge directo**; usar cherry-pick/rebase selectivo."
            if [ -z "$number" ]; then
              gh pr create --base main --head "$br" --title "$title" --body "$body" --draft
              gh pr edit --add-label "upstream-sweep,do-not-merge" || true
            else
              gh pr edit "$number" --title "$title" --body "$body" --add-label "upstream-sweep" || true
              gh pr comment "$number" --body "ðŸ”„ \`$br\` actualizado."
            fi
          done


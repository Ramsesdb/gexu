name: Upstream sweep
on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 6 * * *"
  push:
    branches: ["main"]

permissions:
  contents: write
  pull-requests: write

jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set git identity
        run: |
          git config user.name  "gexu-bot"
          git config user.email "gexu-bot@users.noreply.github.com"
      - name: Ensure labels exist
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh label create "upstream-sweep" --color BFD4F2 --description "Automated sweep from upstream forks" -f || true
          gh label create "do-not-merge" --color d73a4a --description "Do not merge PRs from automated upstream sweep" -f || true
      - name: Mirror forks into vendor/*
        run: bash scripts/bootstrap-vendors.sh
      - name: Open/Update PRs vendor/* -> main
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          for br in vendor/upstream vendor/j2k vendor/sy vendor/yokai vendor/neko vendor/komikku; do
            number=$(gh pr list --base main --head "$br" --state open --json number --jq '.[0].number' || true)
            title="Upstream sweep: ${br#vendor/}"
            body="PR automÃ¡tico para revisar cambios de \`${br#vendor/}\` contra \`main\`.\n\n**No hacer merge directo**; usar cherry-pick/rebase selectivo."
            if [ -z "$number" ]; then
              number=$(gh pr create --base main --head "$br" --title "$title" --body "$body" --draft --json number --jq .number)
              gh pr edit "$number" --add-label "upstream-sweep,do-not-merge" || true
            else
              gh pr edit "$number" --title "$title" --body "$body" --add-label "upstream-sweep" || true
              gh pr comment "$number" --body "ðŸ”„ \`$br\` actualizado."
            fi
          done

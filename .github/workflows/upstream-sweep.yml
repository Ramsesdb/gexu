name: Upstream sweep
on:
  workflow_dispatch:
    inputs:
      head_branch:
        description: "Branch to PR from"
        required: true
        default: "feat/rebranding-gexu"
      base_branch:
        description: "Base branch"
        required: true
        default: "main"
  schedule:
    - cron: "0 6 * * *"
  push:
    branches: ["main"]

permissions:
  contents: write # pushes vendor/* mirrors
  pull-requests: write

jobs:
  sweep:
    runs-on: ubuntu-latest
    env:
      HEAD_BRANCH: ${{ github.event.inputs.head_branch || 'feat/rebranding-gexu' }}
      BASE_BRANCH: ${{ github.event.inputs.base_branch || 'main' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set git identity
        run: |
          git config user.name  "gexu-bot"
          git config user.email "gexu-bot@users.noreply.github.com"
      - name: Sync vendor branches into origin/vendor/*
        run: |
          bash scripts/vendors_sync.sh
      - name: Prepare head branch
        run: |
          set -euo pipefail
          if git show-ref --verify --quiet "refs/heads/$HEAD_BRANCH"; then
            git checkout "$HEAD_BRANCH"
          elif git ls-remote --exit-code origin "$HEAD_BRANCH" >/dev/null 2>&1; then
            git checkout -b "$HEAD_BRANCH" "origin/$HEAD_BRANCH"
          else
            git checkout -b "$HEAD_BRANCH"
          fi
          git push origin "$HEAD_BRANCH" --set-upstream
      - name: Open/Update PRs vendor/* -> main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          for br in vendor/upstream vendor/j2k vendor/sy vendor/yokai vendor/neko vendor/komikku; do
            number=$(gh pr list --base "$BASE_BRANCH" --head "$br" --state open --json number --jq '.[0].number' || true)
            title="Upstream sweep: ${br#vendor/}"
            body="PR automÃ¡tico para revisar cambios de \`${br#vendor/}\` contra \`$BASE_BRANCH\`.\n\n**No hacer merge directo**; usar cherry-pick/rebase selectivo."
            if [ -z "$number" ]; then
              pr_url=$(gh pr create --base "$BASE_BRANCH" --head "$HEAD_BRANCH" --title "$title" --body "$body" --draft)
              number=${pr_url##*/}
              echo "PR_URL=$pr_url"
              echo "PR_NUMBER=$number"
              gh pr edit "$number" --add-label "upstream-sweep,do-not-merge" || true
            else
              echo "PR_NUMBER=$number"
              gh pr edit "$number" --title "$title" --body "$body" --add-label "upstream-sweep" || true
              gh pr comment "$number" --body "ðŸ”„ \`$br\` actualizado."
            fi
          done
